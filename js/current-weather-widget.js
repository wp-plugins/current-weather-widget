(function($){'use strict';var d,apiUrl='http://api.openweathermap.org/data/2.1/find/name',cacheKey='currentWeatherWidgetData',cacheData,p='current-weather-widget',canCache=(function(){try{return'sessionStorage'in window&&window.localStorage!==null&&window.hasOwnProperty('JSON')&&JSON.hasOwnProperty('stringify')&&JSON.hasOwnProperty('parse');}catch(e){return false;}}()),renderTemp=function(classPart,data){var unit;if(classPart==='temp'){unit=' &deg;'+((d.units==='imperial')?'F':'C');}else{data=Math.round(data);unit='&deg;';}
$('.'+p+'-'+classPart).html(data+unit);},showWeather=function(data){renderTemp('temp',data.temp);renderTemp('high',data.high);renderTemp('low',data.low);},setCache=function(data){sessionStorage.setItem(cacheKey,JSON.stringify({"cached":new Date().getTime(),"city":d.city,"country":d.country,"units":d.units,"lang":d.lang,"temp":data.temp,"high":data.high,"low":data.low}));},checkCache=function(){var data=JSON.parse(sessionStorage.getItem(cacheKey));if(data){if(d.city===data.city&&d.country===data.country&&d.units===data.units&&d.lang===data.lang){return data;}}
return false;},useCache=function(data){if(10>(new Date().getTime()-data.cached)/(1000*60)){showWeather(data);return true;}
return false;},parseResponse=function(data){var w,img='',desc,r={temp:'',high:'',low:''};if(data&&data.list&&data.list.length){w=data.list[0];if(w.weather&&w.weather.length&&w.weather[0].icon){desc=w.weather[0].description[0].toUpperCase()+
w.weather[0].description.substring(1);img='<img src="http://openweathermap.org/img/w/'+
w.weather[0].icon+'.png" alt="'+desc+'" title="'+desc+'" /> ';}
if(w.main){r.temp=img+' '+data.list[0].main.temp;r.high=data.list[0].main.temp_max;r.low=data.list[0].main.temp_min;return r;}}
return false;},currentWeatherWidgetFail=function(){$('.'+p).css('display','none');},currentWeatherSucess=function(data){data=parseResponse(data);if(data){showWeather(data);if(canCache){setCache(data);}}};if('currentWeatherWidgetData'in window){d=currentWeatherWidgetData;if(canCache&&(cacheData=checkCache())){if(useCache(cacheData)){return;}}
$.ajax({url:apiUrl,type:'GET',data:{q:d.city+', '+d.country,units:d.units,lang:d.lang},dataType:'jsonp',success:currentWeatherSucess,error:function(e){currentWeatherWidgetFail();}});}else{currentWeatherWidgetFail();}}(jQuery));